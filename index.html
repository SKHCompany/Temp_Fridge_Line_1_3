<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MQTT Dashboard</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      font-size: 35px;
      background-image: url('background.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
    }

    .container {
      text-align: center;
      margin-top: 80px;
    }

    h1 {
      margin-bottom: 30px;
      color: rgb(232, 244, 5);
      font-size: 100px;
      -webkit-text-stroke: 2px black;
    }

    .row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }

    .row label {
      font-size: 50px;
      font-weight: bolder;
      color: deeppink;
      -webkit-text-stroke: 1.5px black;
      margin-right: 15px;
      width: 220px; /* cố định label rộng 220px */
      text-align: right;
    }

    .row input[type="text"] {
      text-align: center;
      padding: 10px;
      font-size: 40px;
      width: 300px;
      border-radius: 10px;
      margin: 0 15px;
    }

    .row span {
      font-size: 40px;
      font-weight: bold;
      color: orange;
      -webkit-text-stroke: 1px black;
      margin-left: 15px;
      width: 420px; /* cố định ô trạng thái rộng 420px */
      text-align: left;
    }

  </style>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>GIÁM SÁT NHIỆT ĐỘ<br>TỦ BẢO QUẢN LINE 1 - 3</h1>

    <!-- Hàng 1: Topic esp32/temperatureC -->
    <div class="row">
      <label for="temp1">Line 1:</label>
      <input id="temp1" type="text" value="Đang kết nối..." readonly>
      <span id="status1">⏳ Đang kết nối...</span>
    </div>

    <!-- Hàng 2: Topic esp32/temperatureC2 -->
    <div class="row">
      <label for="temp2">Line 3:</label>
      <input id="temp2" type="text" value="Đang kết nối..." readonly>
      <span id="status2">⏳ Đang kết nối...</span>
    </div>
  </div>

  <script>
    const options = {
      username: "user01",
      password: "Zxcv1234",
      connectTimeout: 5000,
      clean: true,
      reconnectPeriod: 1000
    };

    const client = mqtt.connect("wss://6142ecdbd79141889c4aff6297385b1d.s1.eu.hivemq.cloud:8884/mqtt", options);

    // Lưu thời gian nhận gói cuối cho từng topic
    let lastMessageTime1 = Date.now();
    let lastMessageTime2 = Date.now();

    client.on('connect', () => {
      console.log('✅ Đã kết nối MQTT WebSocket');

      // Subscribe cho từng topic
      client.subscribe("esp32/22/temperatureC", function (err) {
        if (!err) console.log("✅ Subscribed esp32/temperatureC");
      });

      client.subscribe("esp32/21/temperatureC", function (err) {
        if (!err) console.log("✅ Subscribed esp32/temperatureC2");
      });
    });

    client.on('message', function (topic, message) {
      const temp = message.toString();

      let displayText, statusText, statusColor;

      if (temp === "-127.0" || temp === "-127") {
        displayText = "Lỗi cảm biến";
        statusText = "⚠️ Cảm biến không phản hồi!";
        statusColor = "orange";
      } else {
        displayText = temp + " °C";
        statusText = "✅ Đã kết nối";
        statusColor = "lightgreen";
      }

      if (topic === "esp32/22/temperatureC") {
        document.getElementById("temp1").value = displayText;
        document.getElementById("status1").innerText = statusText;
        document.getElementById("status1").style.color = statusColor;
        lastMessageTime1 = Date.now();
      }

      if (topic === "esp32/21/temperatureC") {
        document.getElementById("temp2").value = displayText;
        document.getElementById("status2").innerText = statusText;
        document.getElementById("status2").style.color = statusColor;
        lastMessageTime2 = Date.now();
      }
    });

    client.on('error', function (err) {
      console.error("❌ Lỗi MQTT: ", err);
    });

    // Kiểm tra mất kết nối cho từng topic
    setInterval(() => {
      const now = Date.now();

      if (now - lastMessageTime1 > 10000) {
        document.getElementById("status1").innerText = "❌ Mất kết nối L1";
        document.getElementById("status1").style.color = "red";
      }

      if (now - lastMessageTime2 > 10000) {
        document.getElementById("status2").innerText = "❌ Mất kết nối L3";
        document.getElementById("status2").style.color = "red";
      }
    }, 2000);
  </script>
</body>
</html>
